% File: analyze_and_plot_results.m
function analyze_and_plot_results(results_data, success_threshold, figures_dir)
% ANALYZE_AND_PLOT_RESULTS - Quickly calculates success rates and plots the results
%                            based on in-memory data and a specified threshold.
%
% Inputs:
%   results_data       - The struct containing all data, generated by the load_all_results function.
%   success_threshold  - The threshold for determining success (a final relative error < this value is considered a success).
%   figures_dir        - The directory path for saving the generated figures.

% --- New: Define a struct for font sizes ---
fontSizeOptions = struct(...
    'title', 16, ...
    'labels', 24, ...
    'ticks', 25, ...
    'legend', 18 ...
);

fprintf('============================================================\n');
fprintf('       Starting analysis... (Success Threshold = %.4f)\n', success_threshold);
fprintf('============================================================\n\n');

% Unpack data from the results struct
all_errors = results_data.all_final_errors;
executed_algos = results_data.executed_algos;
missing_rates = results_data.missing_rates;
ranks = results_data.ranks;
mc_trials = results_data.mc_trials;
[num_mr, num_r, num_algos, ~] = size(all_errors);

% --- Core Calculation Step (Vectorized for speed) ---
% 1. Compare all errors against the threshold to get a logical (boolean) matrix.
is_successful = all_errors < success_threshold;

% 2. Sum along the 4th dimension (Monte Carlo iterations) to get the number of successful
%    runs for each (mr, r, algo) combination.
success_counts = sum(is_successful, 4);

% 3. Divide by the total number of trials to get the success rate.
success_rates = success_counts / mc_trials;

% --- Display and Plotting Section ---

% 8.1. Display the success rate table in the command line
fprintf('Displaying success probability table (based on %d Monte Carlo simulations, threshold=%.1e):\n', mc_trials, success_threshold);
for algo_idx = 1:num_algos
    algo_name = executed_algos{algo_idx};
    fprintf('\nAlgorithm: %s\n', algo_name);
    
    % Create a table with success rates, where rows are missing rates and columns are ranks.
    table_data = array2table(success_rates(:,:,algo_idx), ...
        'RowNames', arrayfun(@(x) sprintf('Missing Rate %.1f', x), missing_rates, 'UniformOutput', false), ...
        'VariableNames', arrayfun(@(x) sprintf('Rank %d', x), ranks, 'UniformOutput', false));
    disp(table_data);
end

% 8.2. Plot and save a success probability heatmap for each algorithm
fprintf('\nGenerating and saving heatmaps...\n');
for algo_idx = 1:num_algos
    algo_name = executed_algos{algo_idx};
    
    % Create a figure window
    h_fig = figure('Name', sprintf('Success Probability - %s (Thresh=%.2f)', algo_name, success_threshold), ...
                   'NumberTitle', 'off', 'Position', [100, 100, 700, 500], 'Visible', 'on'); % Slightly enlarged the canvas to accommodate larger fonts
    
    % Plot the heatmap
    imagesc(ranks, missing_rates, success_rates(:,:,algo_idx));
    colorbar;
    clim([0, 1]); % Lock the color bar range from 0 to 1
    
    % --- Modification: Apply the new font sizes ---
    xlabel('Rank (r)', 'FontSize', fontSizeOptions.labels);
    ylabel('Missing rate', 'FontSize', fontSizeOptions.labels);
    %title(sprintf('Algorithm: %s (Threshold = %.2f)', strrep(algo_name, '_', '\_'), success_threshold), 'FontSize', fontSizeOptions.title);
    
    % Set the axis direction and tick font size
    set(gca, 'YDir', 'normal', 'FontSize', fontSizeOptions.ticks);
    % Note: The legend font size is typically set when creating the legend, e.g.:
    % lgd = legend(...);
    % set(lgd, 'FontSize', fontSizeOptions.legend);
    % The current heatmap does not have a legend, so this option is not used.
    
    % Add threshold information to the filename to avoid overwriting
    filename_suffix = sprintf('%s_thresh_%.2f', algo_name, success_threshold);

    % Save as PNG format
    png_filename = fullfile(figures_dir, sprintf('success_prob_%s.png', filename_suffix));
    saveas(h_fig, png_filename);
    fprintf('Success probability heatmap (PNG) saved to: %s\n', png_filename);
    
    % Save as FIG format
    fig_filename = fullfile(figures_dir, sprintf('success_prob_%s.fig', filename_suffix));
    savefig(h_fig, fig_filename);
    fprintf('Success probability heatmap (FIG) saved to: %s\n\n', fig_filename);
    
    close(h_fig); % Close the current figure window to free up memory
end

fprintf('All analysis tasks completed!\n\n');
end